# CPX42: 8 vCPU, 16GB RAM, 320GB SSD
services:
  wordpress:
    image: wordpress:php8.3-fpm-alpine
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.demo-cpx42-wordpress.rule=Host(`demo-cpx42.hellowp.cloud`)"
      - "traefik.http.routers.demo-cpx42-wordpress.entrypoints=https"
      - "traefik.http.routers.demo-cpx42-wordpress.tls=true"
      - "traefik.http.routers.demo-cpx42-wordpress.tls.certresolver=letsencrypt"
      - "traefik.http.services.demo-cpx42-wordpress.loadbalancer.server.port=80"
    volumes:
      - wordpress-files:/var/www/html
      - ./php-custom.ini:/usr/local/etc/php/conf.d/custom.ini:ro
    environment:
      - SERVICE_FQDN_WORDPRESS=https://demo-cpx42.hellowp.cloud
      - WORDPRESS_DB_HOST=mariadb
      - WORDPRESS_DB_USER=$SERVICE_USER_WORDPRESS
      - WORDPRESS_DB_PASSWORD=$SERVICE_PASSWORD_WORDPRESS
      - WORDPRESS_DB_NAME=wordpress
      - WORDPRESS_CONFIG_EXTRA=
          define('WP_REDIS_HOST', 'redis');
          define('WP_REDIS_PORT', 6379);
          define('WP_REDIS_DATABASE', 0);
          define('WP_CACHE', true);
          define('WP_MEMORY_LIMIT', '768M');
          define('WP_MAX_MEMORY_LIMIT', '1536M');
          define('DISABLE_WP_CRON', false);
          define('WP_POST_REVISIONS', 5);
          define('AUTOSAVE_INTERVAL', 120);
          define('EMPTY_TRASH_DAYS', 14);
    deploy:
      resources:
        limits:
          cpus: '3.0'
          memory: 1536M
        reservations:
          cpus: '1.0'
          memory: 768M
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "php-fpm-healthcheck"]
      interval: 10s
      timeout: 5s
      retries: 5

  nginx:
    image: nginx:alpine
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.demo-cpx42-nginx.rule=Host(`demo-cpx42.hellowp.cloud`)"
      - "traefik.http.routers.demo-cpx42-nginx.entrypoints=https"
      - "traefik.http.routers.demo-cpx42-nginx.tls=true"
      - "traefik.http.routers.demo-cpx42-nginx.tls.certresolver=letsencrypt"
      - "traefik.http.services.demo-cpx42-nginx.loadbalancer.server.port=80"
    volumes:
      - wordpress-files:/var/www/html:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 384M
        reservations:
          cpus: '0.5'
          memory: 192M
    depends_on:
      - wordpress
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1/nginx-health"]
      interval: 10s
      timeout: 5s
      retries: 5

  mariadb:
    image: mariadb:11.4
    volumes:
      - mariadb-data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=$SERVICE_PASSWORD_ROOT
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=$SERVICE_USER_WORDPRESS
      - MYSQL_PASSWORD=$SERVICE_PASSWORD_WORDPRESS
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --innodb-buffer-pool-size=4G
      - --innodb-buffer-pool-instances=4
      - --innodb-log-file-size=256M
      - --innodb-flush-log-at-trx-commit=2
      - --innodb-flush-method=O_DIRECT
      - --innodb-io-capacity=2000
      - --skip-name-resolve
      - --max-connections=200
      - --query-cache-type=1
      - --query-cache-size=128M
      - --tmp-table-size=128M
      - --max-heap-table-size=128M
      - --join-buffer-size=8M
      - --sort-buffer-size=8M
    deploy:
      resources:
        limits:
          cpus: '3.0'
          memory: 5G
        reservations:
          cpus: '1.0'
          memory: 3G
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru --appendonly no --save ""
    volumes:
      - redis-data:/data
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 640M
        reservations:
          cpus: '0.5'
          memory: 384M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  wordpress-files:
  mariadb-data:
  redis-data:
