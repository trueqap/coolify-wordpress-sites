# CPX82: FrankenPHP High Performance WooCommerce
services:
  wordpress:
    build:
      context: .
      dockerfile: Dockerfile
    networks:
      - default
      - coolify
    volumes:
      - wordpress-files:/app/public
      - caddy-data:/data
      - caddy-config:/config
    environment:
      - SERVER_NAME=demo-xpc82.hellowp.cloud
      - WORDPRESS_DB_HOST=mariadb
      - WORDPRESS_DB_USER=$SERVICE_USER_WORDPRESS
      - WORDPRESS_DB_PASSWORD=$SERVICE_PASSWORD_WORDPRESS
      - WORDPRESS_DB_NAME=wordpress
      - WORDPRESS_CONFIG_EXTRA=
          define('WP_HOME', 'https://demo-xpc82.hellowp.cloud');
          define('WP_SITEURL', 'https://demo-xpc82.hellowp.cloud');
          define('FORCE_SSL_ADMIN', true);
          if (isset($$_SERVER['HTTP_X_FORWARDED_PROTO']) && $$_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') { $$_SERVER['HTTPS'] = 'on'; }
          define('WP_REDIS_HOST', 'redis');
          define('WP_REDIS_PORT', 6379);
          define('WP_REDIS_DATABASE', 0);
          define('WP_REDIS_TIMEOUT', 1);
          define('WP_REDIS_READ_TIMEOUT', 1);
          define('WP_CACHE', true);
          define('WP_MEMORY_LIMIT', '1024M');
          define('WP_MAX_MEMORY_LIMIT', '1024M');
          define('DISABLE_WP_CRON', false);
          define('WP_POST_REVISIONS', 5);
          define('AUTOSAVE_INTERVAL', 120);
          define('EMPTY_TRASH_DAYS', 14);
          define('CONCATENATE_SCRIPTS', false);
          define('COMPRESS_SCRIPTS', true);
          define('COMPRESS_CSS', true);
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.demo-xpc82.rule=Host(`demo-xpc82.hellowp.cloud`)"
      - "traefik.http.routers.demo-xpc82.entrypoints=https"
      - "traefik.http.routers.demo-xpc82.tls=true"
      - "traefik.http.routers.demo-xpc82.tls.certresolver=letsencrypt"
      - "traefik.http.services.demo-xpc82.loadbalancer.server.port=80"
      - "traefik.docker.network=coolify"
    deploy:
      resources:
        limits:
          cpus: '8.0'
          memory: 4G
        reservations:
          cpus: '4.0'
          memory: 2G
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/index.php"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  mariadb:
    image: mariadb:11.4
    volumes:
      - mariadb-data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=$SERVICE_PASSWORD_ROOT
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=$SERVICE_USER_WORDPRESS
      - MYSQL_PASSWORD=$SERVICE_PASSWORD_WORDPRESS
    command:
      # Character set
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      # InnoDB Buffer Pool (MariaDB 11.4 compatible)
      - --innodb-buffer-pool-size=14G
      # InnoDB Log settings
      - --innodb-log-file-size=2G
      - --innodb-log-buffer-size=256M
      # InnoDB Performance
      - --innodb-flush-log-at-trx-commit=2
      - --innodb-flush-method=O_DIRECT
      - --innodb-doublewrite=0
      - --innodb-io-capacity=2000
      - --innodb-io-capacity-max=4000
      - --innodb-read-io-threads=8
      - --innodb-write-io-threads=8
      - --innodb-lru-scan-depth=256
      - --innodb-purge-threads=4
      - --innodb-adaptive-hash-index=ON
      - --innodb-file-per-table=1
      # Connection settings
      - --skip-name-resolve
      - --max-connections=500
      - --thread-cache-size=128
      - --table-open-cache=8192
      - --table-definition-cache=4096
      - --open-files-limit=65535
      # Temp tables
      - --tmp-table-size=256M
      - --max-heap-table-size=256M
      # Buffer sizes per connection
      - --join-buffer-size=8M
      - --sort-buffer-size=8M
      - --read-buffer-size=2M
      - --read-rnd-buffer-size=4M
      # Binary log
      - --sync-binlog=0
      - --binlog-expire-logs-seconds=86400
      # Performance schema
      - --performance-schema=OFF
    deploy:
      resources:
        limits:
          cpus: '6.0'
          memory: 20G
        reservations:
          cpus: '4.0'
          memory: 16G
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    command: >
      redis-server
      --maxmemory 2048mb
      --maxmemory-policy allkeys-lru
      --appendonly no
      --save ""
      --tcp-keepalive 300
      --tcp-backlog 511
      --timeout 0
      --activedefrag yes
      --active-defrag-threshold-lower 10
      --lazyfree-lazy-eviction yes
      --lazyfree-lazy-expire yes
      --lazyfree-lazy-server-del yes
    volumes:
      - redis-data:/data
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2560M
        reservations:
          cpus: '1.0'
          memory: 2048M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  ssh:
    image: trueqap/wordpress-ssh:v2.1.1-acl
    ports:
      - "2223:2222"
    volumes:
      - wordpress-files:/wordpress
    environment:
      - SFTP_PASSWORD=${SFTP_PASSWORD:-changeme}
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD-SHELL", "pgrep sshd > /dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  adminer:
    image: adminer:4-standalone
    networks:
      - default
      - coolify
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.db-demo-xpc82.rule=Host(`db-demo-xpc82.hellowp.cloud`)"
      - "traefik.http.routers.db-demo-xpc82.entrypoints=https"
      - "traefik.http.routers.db-demo-xpc82.tls=true"
      - "traefik.http.routers.db-demo-xpc82.tls.certresolver=letsencrypt"
      - "traefik.http.services.db-demo-xpc82.loadbalancer.server.port=8080"
    environment:
      - ADMINER_DEFAULT_SERVER=mariadb
      - ADMINER_DESIGN=nette
    deploy:
      resources:
        limits:
          cpus: '0.15'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 32M
    depends_on:
      mariadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "php -r 'exit(0);'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  coolify:
    external: true

volumes:
  wordpress-files:
  mariadb-data:
  redis-data:
  caddy-data:
  caddy-config:
