# demo-cpx72 - Trellis production 1:1 beállítások
services:
  wordpress:
    build:
      context: .
      dockerfile: Dockerfile.wordpress
    volumes:
      - wordpress-files:/var/www/html
    environment:
      - WORDPRESS_DB_HOST=mariadb
      - WORDPRESS_DB_USER=$SERVICE_USER_WORDPRESS
      - WORDPRESS_DB_PASSWORD=$SERVICE_PASSWORD_WORDPRESS
      - WORDPRESS_DB_NAME=wordpress
      - WORDPRESS_CONFIG_EXTRA=
          define('WP_REDIS_HOST', 'redis');
          define('WP_REDIS_PORT', 6379);
          define('WP_REDIS_DATABASE', 0);
          define('WP_CACHE', true);
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep php-fpm > /dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.demo-cpx72.rule=Host(`demo-cpx72.hellowp.cloud`)"
      - "traefik.http.routers.demo-cpx72.entrypoints=https"
      - "traefik.http.routers.demo-cpx72.tls=true"
      - "traefik.http.routers.demo-cpx72.tls.certresolver=letsencrypt"
      - "traefik.http.services.demo-cpx72.loadbalancer.server.port=80"
    volumes:
      - wordpress-files:/var/www/html:ro
      - nginx-cache:/var/cache/nginx
      - nginx-logs:/var/log/nginx
    depends_on:
      wordpress:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1/nginx-health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  mariadb:
    image: mariadb:10.11
    volumes:
      - mariadb-data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=$SERVICE_PASSWORD_ROOT
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=$SERVICE_USER_WORDPRESS
      - MYSQL_PASSWORD=$SERVICE_PASSWORD_WORDPRESS
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      # Trellis defaults
      - --innodb-buffer-pool-size=128M
      - --innodb-log-file-size=96M
      - --skip-name-resolve
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    command: >
      redis-server
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly no
      --save "900 1"
      --save "300 10"
      --save "60 10000"
      --tcp-keepalive 0
      --timeout 0
      --databases 16
      --maxclients 10000
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  ssh:
    image: trueqap/wordpress-ssh:v2.1.1-acl
    ports:
      - "2222:2222"
    volumes:
      - wordpress-files:/wordpress
      - nginx-logs:/logs:ro
    environment:
      - SFTP_PASSWORD=${SFTP_PASSWORD:-changeme}
    healthcheck:
      test: ["CMD-SHELL", "pgrep sshd > /dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  adminer:
    image: adminer:4-standalone
    networks:
      - default
      - coolify
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.db-demo-cpx72.rule=Host(`db-demo-cpx72.hellowp.cloud`)"
      - "traefik.http.routers.db-demo-cpx72.entrypoints=https"
      - "traefik.http.routers.db-demo-cpx72.tls=true"
      - "traefik.http.routers.db-demo-cpx72.tls.certresolver=letsencrypt"
      - "traefik.http.services.db-demo-cpx72.loadbalancer.server.port=8080"
    environment:
      - ADMINER_DEFAULT_SERVER=mariadb
      - ADMINER_DESIGN=nette
    depends_on:
      mariadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "php -r 'exit(0);'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  coolify:
    external: true

volumes:
  wordpress-files:
  mariadb-data:
  redis-data:
  nginx-cache:
  nginx-logs:
